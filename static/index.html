<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <title>Racer command page</title>
        <style>
            #arrow {
                width: 200px;
            }

            #capture-btn {
                padding: 10px;
                color: white;
                font-weight: 800;
            }
        </style>

    </head>
    <body>
        <img src="arrow.png" id="arrow" alt="">
        <br />
        <button id="capture-btn">Start capturing video</button>
    </body>


    <script>
        const arrow = document.getElementById("arrow");
        const button = document.getElementById("capture-btn");

        const request = async route => {
            return (await fetch(route)).json()
        };

        const updateThrottle = async throttle => {
            // TODO: use it
            const { value } = await request(`/throttle/${throttle}`);
            return value;
        };

        const updateSteering = async delta => {
            const { value } = await request(`/steer/${delta}`);
            // TODO remove magic number 25 here (supposed to be max angle of rotation for servo on the car)
            arrow.style.transform = `rotate(${25*value}deg)`;
            return value;
        };

        const handleCapture = capturing => {
            button.textContent = capturing ? "Stop video capture" : "Start video capture";
            button.style.background = capturing ? "red" : "green";
        };

        const steeringQuantum = 0.05;
        const throttleQuantum = 0.05;

        (async () => {
            let capturing = (await request("/capture")).value;
            handleCapture(capturing);

            document.addEventListener("keydown", async ev => {
                if (ev.code === 'ArrowLeft') {
                    await updateSteering(-steeringQuantum);
                } else if (ev.code === 'ArrowRight') {
                    await updateSteering(steeringQuantum);
                } else if (ev.code === 'ArrowUp') {
                await updateThrottle(throttleQuantum);
                } else if (ev.code === 'ArrowDown') {
                    await updateThrottle(-throttleQuantum);
                }
        });

            button.addEventListener("click", async ev => {
                if (capturing) {
                    capturing = (await request("/capture/stop")).value;
                }else{
                    capturing = (await request("/capture/start")).value;
                }
                handleCapture(capturing)
            })
        })()
    </script>
</html>
